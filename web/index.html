<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TORM - Go语言的优雅ORM库</title>
    <link rel="icon" href="assets/logo.svg" type="image/x-icon">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="assets/logo.svg" alt="TORM" class="logo">
                <span class="brand-text">TORM</span>
            </div>
            <div class="nav-menu" id="nav-menu">
                <a href="docs.html" class="nav-link">文档</a>
                <a href="docs.html?doc=examples" class="nav-link">示例</a>
                <a href="#" class="nav-link">社区</a>
                <a href="#" class="nav-link">API</a>
                <a href="docs.html?doc=contributing" class="nav-link">贡献</a>
                <div class="language-selector">
                    <select id="language-select">
                        <option value="zh">简体中文</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
            <div class="nav-toggle" id="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- 主页内容 -->
    <main class="main-content">
        <!-- 英雄区域 -->
        <section class="hero">
            <div class="hero-background"></div>
            <div class="container">
                <div class="hero-content">
                    <h1 class="hero-title">
                        <span class="hero-title-main">TORM</span>
                        <span class="hero-title-sub">Go语言的优雅ORM库</span>
                    </h1>
                    <div class="hero-install">
                        <code class="install-command">go get -u github.com/zhoudm1743/torm</code>
                        <button class="copy-btn" id="copy-install-btn">复制</button>
                    </div>
                    <div class="hero-stats">
                        <div class="stat-item">
                            <span class="stat-icon">⭐</span>
                            <span class="stat-text">GitHub stars</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">🍴</span>
                            <span class="stat-text">GitHub forks</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">👥</span>
                            <span class="stat-text">贡献者</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 特性展示 -->
        <section class="features">
            <div class="container">
                <h2 class="section-title">为什么选择TORM？</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">🚀</div>
                        <h3>高性能</h3>
                        <p>优化的查询构建器和连接池管理，为您的应用提供极致性能</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🔗</div>
                        <h3>关联关系</h3>
                        <p>完整支持 has one、has many、belongs to、many to many 等关联关系</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🪝</div>
                        <h3>钩子函数</h3>
                        <p>支持 before/after create/save/update/delete/find 等生命周期钩子</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">📊</div>
                        <h3>数据迁移</h3>
                        <p>内置强大的数据库迁移工具，轻松管理数据库版本</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">💾</div>
                        <h3>多数据库支持</h3>
                        <p>支持 MySQL、PostgreSQL、SQLite、MongoDB 等多种数据库</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🔒</div>
                        <h3>事务处理</h3>
                        <p>完整的事务支持，包括嵌套事务、保存点等高级功能</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🎯</div>
                        <h3>查询构建器</h3>
                        <p>强大的 SQL 查询构建器，支持复杂查询和子查询</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🧰</div>
                        <h3>开发友好</h3>
                        <p>详细的文档、丰富的示例，让开发更加轻松愉快</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 代码示例 -->
        <section class="code-demo">
            <div class="container">
                <h2 class="section-title">快速上手</h2>
                <div class="demo-tabs">
                    <button class="tab-btn active" data-tab="basic">基础操作</button>
                    <button class="tab-btn" data-tab="model">模型操作</button>
                    <button class="tab-btn" data-tab="migration">数据迁移</button>
                    <button class="tab-btn" data-tab="transaction">事务处理</button>
                </div>
                <div class="demo-content">
                    <div class="tab-content active" id="basic">
                        <pre><code class="language-go">package main

import (
    "log"
    
    "github.com/zhoudm1743/torm/db"
)

type User struct {
    ID        int    `db:"id" json:"id"`
    Name      string `db:"name" json:"name"`
    Email     string `db:"email" json:"email"`
    Age       int    `db:"age" json:"age"`
    Status    string `db:"status" json:"status"`
    CreatedAt string `db:"created_at" json:"created_at"`
    UpdatedAt string `db:"updated_at" json:"updated_at"`
}

func main() {
    // 配置数据库连接
    config := &db.Config{
        Driver:   "mysql",
        Host:     "localhost",
        Port:     3306,
        Username: "root",
        Password: "password",
        Database: "torm_example",
    }
    err := db.AddConnection("default", config)
    if err != nil {
        log.Fatal(err)
    }
    
    // ===== TORM查询构建器演示 =====
    log.Println("===== TORM查询构建器演示 =====")

    // 基础查询
    query, err := db.Table("users", "default")
    if err == nil {
        // 查询所有用户
        users, err := query.Select("id", "name", "email", "age").
            Where("status", "=", "active").
            OrderBy("created_at", "desc").
            Limit(5).
            Get()
        if err == nil {
            log.Printf("查询到 %d 个活跃用户", len(users))
        }

        // 条件查询
        adults, err := query.Where("age", ">=", 18).
            Where("status", "=", "active").
            Count()
        if err == nil {
            log.Printf("成年活跃用户数量: %d", adults)
        }
    }

    // ===== TORM支持两种查询方式 =====
    log.Println("===== TORM支持两种查询方式 =====")
    
    // 方式1: 传统三参数方式
    users, err := query.Where("age", ">", 18).
        Where("status", "=", "active").Get()
    if err == nil {
        log.Printf("传统方式查询用户: %d 个", len(users))
    }
    
    // 方式2: 参数化查询方式
    users, err = query.Where("name = ?", "张三").Get()
    if err == nil {
        log.Printf("参数化查询用户: %d 个", len(users))
    }
    
    // 方式3: 混合使用两种方式
    users, err = query.Where("age", ">=", 18).        // 传统方式
        Where("name LIKE ?", "%王%").                  // 参数化方式
        Where("status", "=", "active").               // 传统方式
        Where("email IS NOT NULL").Get()              // 原生SQL
    if err == nil {
        log.Printf("混合查询用户: %d 个", len(users))
    }

    // ===== First和Find增强功能演示 =====
    log.Println("===== First和Find增强功能演示 =====")
    
    // 查询单个用户 - 参数化方式
    var user User
    _, err = query.Where("id = ?", 1).First(&user)
    if err == nil {
        log.Printf("用户信息: %s (%s)", user.Name, user.Email)
    }
    
    // 查询单个用户 - 传统方式
    var user2 User
    _, err = query.Where("id", "=", 1).First(&user2)
    if err == nil {
        log.Printf("用户信息(传统方式): %s (%s)", user2.Name, user2.Email)
    }
    
    // 查询多个用户 - 混合方式
    var userList []User
    _, err = query.Where("status", "=", "active").         // 传统方式
        Where("age >= ?", 18).                             // 参数化方式
        Find(&userList)
    if err == nil {
        log.Printf("成年活跃用户数量: %d", len(userList))
    }

    // ===== 高级查询功能演示 =====
    log.Println("===== 高级查询功能演示 =====")
    
    // 复杂条件查询
    complexQuery, err := db.Table("users", "default")
    if err == nil {
        result, err := complexQuery.
            Select("id", "name", "email").
            Where("age BETWEEN ? AND ?", 20, 40).
            Where("status IN (?, ?)", "active", "pending").
            OrderBy("age", "ASC").
            OrderBy("name", "DESC").
            Limit(10).
            Get()
        if err == nil {
            log.Printf("复杂查询结果数量: %d", len(result))
        }
    }

    log.Println("===== TORM演示完成 =====")
}</code></pre>
                    </div>
                    <div class="tab-content" id="model">
                        <pre><code class="language-go">package main

import (
    "errors"
    "log"
    "time"
    
    "github.com/zhoudm1743/torm/db"
    "github.com/zhoudm1743/torm/model"
)

// User 用户模型 - 支持标签配置
type User struct {
    model.BaseModel                                           // 嵌入基础模型
    ID        uint       `json:"id" db:"id" pk:""`           // 主键，pk标签
    Name      string     `json:"name" db:"name"`             // 用户名
    Email     string     `json:"email" db:"email"`           // 邮箱
    Age       int        `json:"age" db:"age"`               // 年龄
    Status    string     `json:"status" db:"status"`         // 状态
    CreatedAt time.Time  `json:"created_at" db:"created_at;autoCreateTime"` // 自动创建时间
    UpdatedAt time.Time  `json:"updated_at" db:"updated_at;autoUpdateTime"` // 自动更新时间
    DeletedAt model.DeletedTime `json:"deleted_at" db:"deleted_at"`          // 软删除时间
}

// NewUser 创建用户模型实例
func NewUser() *User {
    user := &User{
        BaseModel: *model.NewBaseModel(), // BaseModel内置db.QueryInterface
    }
    user.SetTable("users")        // 设置表名
    user.SetConnection("default") // 设置数据库连接
    user.DetectConfigFromStruct(user) // 从结构体标签检测配置（优先级高于基础配置）
    return user
}

// 自定义查询方法 - 活跃用户（参数化查询）
func (u *User) GetActiveUsers() ([]map[string]interface{}, error) {
    return u.Where("status = ?", "active").Get()
}

// 自定义查询方法 - 复合条件（参数化查询）
func (u *User) GetActiveAdults() ([]map[string]interface{}, error) {
    return u.Where("status = ? AND age >= ?", "active", 18).Get()
}

// 生命周期钩子 - 保存前验证
func (u *User) BeforeSave() error {
    if u.GetAttribute("email") == "" {
        return errors.New("邮箱不能为空")
    }
    return nil
}

// 生命周期钩子 - 创建后处理
func (u *User) AfterCreate() error {
    log.Printf("新用户创建: %s", u.GetAttribute("name"))
    return nil
}

func main() {
    // 配置数据库连接
    config := &db.Config{
        Driver:   "mysql",
        Host:     "localhost",
        Port:     3306,
        Username: "root",
        Password: "password",
        Database: "torm_example",
    }
    err := db.AddConnection("default", config)
    if err != nil {
        log.Fatal(err)
    }
    
    // TORM模型系统说明：
    // 1. 模型内置使用db包的QueryInterface进行数据库操作
    // 2. 通过getQueryBuilder()方法获取db.Table()查询构建器
    // 3. 所有Where、Get、First等方法都是对db包查询构建器的封装
    // 4. 支持参数化查询: Where("name = ?", value) 和传统查询: Where("name", "=", value)
    // 5. 默认操作当前模型表，JOIN查询智能处理表名前缀
    
    // ===== 创建用户 =====
    log.Println("===== 创建用户 =====")
    
    // 方式1：直接创建
    user1 := NewUser()
    user1.Name = "张三"
    user1.Email = "zhangsan@example.com"
    user1.Age = 25
    user1.Status = "active"
    err = user1.Save()
    if err != nil {
        log.Printf("创建用户失败: %v", err)
    } else {
        log.Printf("用户 %s 创建成功，ID: %v", user1.Name, user1.GetKey())
    }
    
    // 方式2：批量设置属性
    user2 := NewUser()
    err = user2.Fill(map[string]interface{}{
        "name":   "李四",
        "email":  "lisi@example.com",
        "age":    30,
        "status": "active",
    }).Save()
    if err != nil {
        log.Printf("创建用户失败: %v", err)
    } else {
        log.Printf("用户批量创建成功")
    }
    
    // ===== 查询用户 =====
    log.Println("===== 查询用户 =====")
    
    // 根据主键查找
    user := NewUser()
    err = user.Find(1)
    if err == nil {
        log.Printf("找到用户: %s (%s)", user.Name, user.Email)
    }
    
    // 使用自定义查询方法
    activeUsers := NewUser()
    users, err := activeUsers.GetActiveUsers()
    if err == nil {
        log.Printf("活跃用户数量: %d", len(users))
    }
    
    // 复合条件查询（活跃且成年）- 参数化方式
    adultActiveUsers := NewUser()
    users, err = adultActiveUsers.GetActiveAdults()
    if err == nil {
        log.Printf("活跃成年用户数量: %d", len(users))
    }
    
    // 原生SQL查询
    rawQueryUsers := NewUser()
    users, err = rawQueryUsers.WhereRaw("YEAR(created_at) = ? AND status = ?", 2024, "active").Get()
    if err == nil {
        log.Printf("2024年创建的活跃用户: %d", len(users))
    }
    
    // JOIN查询 - 自动处理模型表名
    joinUsers := NewUser()
    joinResults, err := joinUsers.
        LeftJoin("user_profiles", "user_id", "=", "id").  // 自动处理：user_profiles.user_id = users.id
        Select("users.*", "user_profiles.avatar").
        Where("status = ?", "active").                    // 自动使用users.status
        Get()
    if err == nil {
        log.Printf("智能JOIN查询结果: %d 条记录", len(joinResults))
    }
    
    // 分组查询 - 适配db.GroupBy功能
    groupUsers := NewUser()
    groupResults, err := groupUsers.
        SelectRaw("status, COUNT(*) as count").
        GroupBy("status").
        Having("count", ">", 0).
        Get()
    if err == nil {
        log.Printf("按状态分组结果: %d 个组", len(groupResults))
    }
    
    // 使用模型的Where方法（传统三参数方式）
    user3 := NewUser()
    err = user3.Where("email", "=", "zhangsan@example.com").First()
    if err == nil {
        log.Printf("通过邮箱找到用户: %s", user3.Name)
    }
    
    // 参数化查询方式
    user4 := NewUser()
    err = user4.Where("name = ? AND age >= ?", "李四", 25).First()
    if err == nil {
        log.Printf("通过参数化查询找到用户: %s", user4.Name)
    }
    
    // 混合查询方式
    user5 := NewUser()
    err = user5.Where("status", "=", "active").           // 传统方式
        Where("name LIKE ?", "%李%").                      // 参数化方式
        OrWhere("email = ?", "admin@example.com").        // OR参数化方式
        First()
    if err == nil {
        log.Printf("通过混合查询找到用户: %s", user5.Name)
    }
    
    // ===== 更新用户 =====
    log.Println("===== 更新用户 =====")
    
    updateUser := NewUser()
    err = updateUser.Find(1)
    if err == nil {
        updateUser.Age = 26
        updateUser.Status = "premium"
        err = updateUser.Save()
        if err == nil {
            log.Printf("用户更新成功: %s, 新年龄: %d", updateUser.Name, updateUser.Age)
        }
    }
    
    // 批量更新 - 适配db.Update
    updateUser := NewUser()
    affectedRows, err := updateUser.Where("status = ?", "active").
        Update(map[string]interface{}{
            "status": "verified",
        })
    if err == nil {
        log.Printf("批量更新了 %d 个用户状态", affectedRows.(int64))
    }
    
    // 批量插入 - 适配db.InsertBatch
    batchUser := NewUser()
    insertedCount, err := batchUser.InsertBatch([]map[string]interface{}{
        {"name": "批量用户1", "email": "batch1@example.com", "age": 25, "status": "active"},
        {"name": "批量用户2", "email": "batch2@example.com", "age": 30, "status": "active"},
        {"name": "批量用户3", "email": "batch3@example.com", "age": 28, "status": "active"},
    })
    if err == nil {
        log.Printf("批量插入了 %d 个用户", insertedCount)
    }
    
    // ===== 高级查询 =====
    log.Println("===== 高级查询 =====")
    
    // 聚合查询
    countUser := NewUser()
    count, err := countUser.Where("status", "=", "active").Count()
    if err == nil {
        log.Printf("活跃用户数量: %d", count)
    }
    
    // 检查记录是否存在
    existsUser := NewUser()
    exists, err := existsUser.Where("email", "=", "zhangsan@example.com").HasRecords()
    if err == nil {
        log.Printf("邮箱 zhangsan@example.com 是否存在: %t", exists)
    }
    
    // 分页查询
    result, err := NewUser().
        Where("status", "=", "active").
        OrderBy("created_at", "desc").
        Paginate(1, 5) // 第1页，每页5条
    if err == nil {
        log.Printf("分页查询结果: 共%d条，当前页%d条", 
            result.Total, len(result.Data))
    }
    
    // ===== 模型序列化 =====
    log.Println("===== 模型序列化 =====")
    
    serializeUser := NewUser()
    err = serializeUser.Find(1)
    if err == nil {
        // 转换为Map
        userData := serializeUser.ToMap()
        log.Printf("用户Map: %+v", userData)
        
        // 获取所有属性
        attributes := serializeUser.GetAttributes()
        log.Printf("用户属性: %+v", attributes)
        
        // 获取主键值
        keyValue := serializeUser.GetKey()
        log.Printf("用户主键: %v", keyValue)
    }
    
    // ===== 查询构建器模型支持演示 =====
    log.Println("===== 查询构建器模型支持演示 =====")
    
    // 直接从模型创建查询构建器 - 自动获取表名和启用模型特性
    userModel := &User{}
    userModel.SetTable("custom_users") // 可选：手动设置表名（优先级最高）
    modelQuery, err := db.Model(userModel)
    if err == nil {
        
                // 插入模型实例 - 自动处理时间戳
        newUser := &User{
            Name:   "数据库用户",
            Email:  "db@example.com",
            Age:    28,
            Status: "active",
        }
        insertedID, err := modelQuery.InsertModel(newUser)
        if err == nil {
            log.Printf("查询构建器插入用户成功，ID: %d", insertedID)
        }
        
        // 查找模型 - 自动填充结构体，自动过滤软删除记录
        var foundUser User
        err = modelQuery.FindModel(insertedID, &foundUser)
        if err == nil {
            log.Printf("查询构建器找到用户: %s (%s)", foundUser.Name, foundUser.Email)
        }
        
        // 更新模型 - 自动处理更新时间戳
        foundUser.Age = 29
        foundUser.Status = "premium"
        affected, err := modelQuery.Where("id = ?", insertedID).UpdateModel(&foundUser)
        if err == nil {
            log.Printf("查询构建器更新用户成功，影响行数: %d", affected)
        }
        
        // 自动软删除过滤 - 只查询未删除的记录
        activeUsers, err := modelQuery.Where("status = ?", "active").Get()
        if err == nil {
            log.Printf("查询到 %d 个活跃用户（自动排除软删除）", len(activeUsers))
        }
    }
    
    log.Println("===== 模型操作演示完成 =====")
}</code></pre>
                    </div>
                    <div class="tab-content" id="migration">
                        <pre><code class="language-go">package main

import (
    "fmt"
    "log"
    
    "github.com/zhoudm1743/torm/db"
    "github.com/zhoudm1743/torm/migration"
)

func main() {
    // 配置数据库连接
    config := &db.Config{
        Driver:   "sqlite",
        Database: "example.db",
    }
    
    err := db.AddConnection("default", config)
    if err != nil {
        log.Fatal(err)
    }
    
    // 获取数据库连接
    conn, err := db.DB("default")
    if err != nil {
        log.Fatal(err)
    }
    
    err = conn.Connect()
    if err != nil {
        log.Fatal(err)
    }
    
    // 创建迁移器
    migrator := migration.NewMigrator(conn, nil)
    
    // 注册用户表迁移 - 使用现代化的结构定义
    migrator.Register("20240101_000001", "创建用户表", 
        func(conn db.ConnectionInterface) error {
            // 使用Table结构定义表
            table := &migration.Table{
                Name: "users",
                Columns: []*migration.Column{
                    {Name: "id", Type: migration.ColumnTypeBigInt, PrimaryKey: true, AutoIncrement: true},
                    {Name: "name", Type: migration.ColumnTypeVarchar, Length: 100, NotNull: true},
                    {Name: "email", Type: migration.ColumnTypeVarchar, Length: 100, NotNull: true},
                    {Name: "age", Type: migration.ColumnTypeInt, NotNull: true, Default: "0"},
                    {Name: "status", Type: migration.ColumnTypeVarchar, Length: 20, Default: "'active'"},
                    {Name: "created_at", Type: migration.ColumnTypeDateTime, Default: "CURRENT_TIMESTAMP"},
                    {Name: "updated_at", Type: migration.ColumnTypeDateTime, Default: "CURRENT_TIMESTAMP"},
                },
                Indexes: []*migration.Index{
                    {Name: "idx_users_email", Columns: []string{"email"}, Unique: true},
                    {Name: "idx_users_status", Columns: []string{"status"}},
                },
            }
            
            schema := migration.NewSchemaBuilder(conn)
            return schema.CreateTable(table)
        },
        func(conn db.ConnectionInterface) error {
            schema := migration.NewSchemaBuilder(conn)
            return schema.DropTable("users")
        },
    )
    
    // 注册文章表迁移
    migrator.Register("20240101_000002", "创建文章表",
        func(conn db.ConnectionInterface) error {
            table := &migration.Table{
                Name: "posts",
                Columns: []*migration.Column{
                    {Name: "id", Type: migration.ColumnTypeBigInt, PrimaryKey: true, AutoIncrement: true},
                    {Name: "user_id", Type: migration.ColumnTypeBigInt, NotNull: true},
                    {Name: "title", Type: migration.ColumnTypeVarchar, Length: 200, NotNull: true},
                    {Name: "content", Type: migration.ColumnTypeText},
                    {Name: "status", Type: migration.ColumnTypeVarchar, Length: 20, Default: "'draft'"},
                    {Name: "created_at", Type: migration.ColumnTypeDateTime, Default: "CURRENT_TIMESTAMP"},
                    {Name: "updated_at", Type: migration.ColumnTypeDateTime, Default: "CURRENT_TIMESTAMP"},
                },
                ForeignKeys: []*migration.ForeignKey{
                    {
                        Name:           "fk_posts_user_id",
                        Columns:        []string{"user_id"},
                        ReferencedTable: "users",
                        ReferencedColumns: []string{"id"},
                        OnDelete:       "CASCADE",
                        OnUpdate:       "CASCADE",
                    },
                },
            }
            
            schema := migration.NewSchemaBuilder(conn)
            return schema.CreateTable(table)
        },
        func(conn db.ConnectionInterface) error {
            schema := migration.NewSchemaBuilder(conn)
            return schema.DropTable("posts")
        },
    )
    
    // 执行迁移
    err = migrator.Up()
    if err != nil {
        fmt.Printf("迁移失败: %v\n", err)
        return
    }
    fmt.Println("✅ 数据库迁移完成!")
    
    // 显示迁移状态
    migrator.PrintStatus()
    
    // 演示回滚最后一个迁移
    fmt.Println("\n🔄 演示回滚最后一个迁移...")
    err = migrator.Down()
    if err != nil {
        fmt.Printf("回滚失败: %v\n", err)
    } else {
        fmt.Println("✅ 回滚成功!")
        migrator.PrintStatus()
    }
}</code></pre>
                    </div>
                    <div class="tab-content" id="transaction">
                        <pre><code class="language-go">package main

import (
    "fmt"
    "log"
    
    "github.com/zhoudm1743/torm/db"
)

// 账户操作业务逻辑 - 完全基于查询构建器
func createAccount(userID int64, initialBalance float64) (int64, error) {
    query, err := db.Table("accounts")
    if err != nil {
        return 0, err
    }
    
    return query.Insert(map[string]interface{}{
        "user_id":    userID,
        "balance":    initialBalance,
        "status":     "active",
        "created_at": "2024-01-01 10:00:00",
        "updated_at": "2024-01-01 10:00:00",
    })
}

func getAccountBalance(userID int64) (float64, error) {
    query, err := db.Table("accounts")
    if err != nil {
        return 0, err
    }
    
    account, err := query.Select("balance").Where("user_id", "=", userID).First()
    if err != nil {
        return 0, err
    }
    
    // TORM返回的是map[string]interface{}，需要类型断言
    balance, ok := account["balance"].(float64)
    if !ok {
        // 尝试其他可能的数字类型
        if intVal, ok := account["balance"].(int64); ok {
            balance = float64(intVal)
        } else {
            return 0, fmt.Errorf("余额数据类型错误")
        }
    }
    
    return balance, nil
}

func updateAccountBalance(userID int64, newBalance float64) error {
    query, err := db.Table("accounts")
    if err != nil {
        return err
    }
    
    affected, err := query.Where("user_id", "=", userID).Update(map[string]interface{}{
        "balance":    newBalance,
        "updated_at": "2024-01-01 11:00:00",
    })
    
    if err != nil {
        return err
    }
    
    if affected == 0 {
        return fmt.Errorf("账户不存在")
    }
    
    return nil
}

func createTransferLog(fromUserID, toUserID int64, amount float64) error {
    query, err := db.Table("transfer_logs")
    if err != nil {
        return err
    }
    
    _, err = query.Insert(map[string]interface{}{
        "from_user_id": fromUserID,
        "to_user_id":   toUserID,
        "amount":       amount,
        "status":       "completed",
        "created_at":   "2024-01-01 11:00:00",
    })
    
    return err
}

// 转账示例 - 查询构建器 + 事务
func transferMoney(fromUserID, toUserID int64, amount float64) error {
    // 事务前验证
    fromBalance, err := getAccountBalance(fromUserID)
    if err != nil {
        return fmt.Errorf("获取发送方余额失败: %v", err)
    }
    
    if fromBalance < amount {
        return fmt.Errorf("余额不足: 当前 %.2f, 需要 %.2f", fromBalance, amount)
    }
    
    toBalance, err := getAccountBalance(toUserID)
    if err != nil {
        return fmt.Errorf("获取接收方余额失败: %v", err)
    }
    
    // 使用TORM的事务API
    return db.Transaction(func(tx db.TransactionInterface) error {
        // 计算新余额
        newFromBalance := fromBalance - amount
        newToBalance := toBalance + amount
        
        // 更新发送方余额
        err := updateAccountBalance(fromUserID, newFromBalance)
        if err != nil {
            return fmt.Errorf("更新发送方余额失败: %v", err)
        }
        
        // 更新接收方余额
        err = updateAccountBalance(toUserID, newToBalance)
        if err != nil {
            return fmt.Errorf("更新接收方余额失败: %v", err)
        }
        
        // 记录转账日志
        err = createTransferLog(fromUserID, toUserID, amount)
        if err != nil {
            return fmt.Errorf("记录转账日志失败: %v", err)
        }
        
        return nil // 自动提交事务
    })
}

func main() {
    // 配置数据库
    config := &db.Config{
        Driver:   "sqlite", 
        Database: "bank.db",
    }
    
    err := db.AddConnection("default", config)
    if err != nil {
        log.Fatal(err)
    }
    
    // 使用业务函数创建测试账户
    fmt.Println("🏦 创建银行账户...")
    account1ID, err := createAccount(1, 1000.00)
    if err != nil {
        log.Fatal(err)
    }
    
    account2ID, err := createAccount(2, 500.00)
    if err != nil {
        log.Fatal(err)
    }
    
    fmt.Printf("✅ 创建账户: %v, %v\n", account1ID, account2ID)
    
    // 显示转账前余额
    fmt.Println("💰 转账前余额:")
    balance1, _ := getAccountBalance(1)
    balance2, _ := getAccountBalance(2)
    fmt.Printf("  用户 1: %.2f\n", balance1)
    fmt.Printf("  用户 2: %.2f\n", balance2)
    
    // 执行转账事务
    fmt.Println("\n🔄 执行转账...")
    err = transferMoney(1, 2, 100.00)
    if err != nil {
        fmt.Printf("❌ 转账失败: %v\n", err)
    } else {
        fmt.Println("✅ 转账成功!")
        
        // 查询转账后的余额
        fmt.Println("\n💰 转账后余额:")
        newBalance1, _ := getAccountBalance(1)
        newBalance2, _ := getAccountBalance(2)
        fmt.Printf("  用户 1: %.2f (变化: %.2f)\n", newBalance1, newBalance1-balance1)
        fmt.Printf("  用户 2: %.2f (变化: %.2f)\n", newBalance2, newBalance2-balance2)
        
        // 查询转账记录
        logQuery, _ := db.Table("transfer_logs")
        logs, err := logQuery.
            Select("from_user_id", "to_user_id", "amount", "status").
            Where("from_user_id", "=", 1).
            Where("to_user_id", "=", 2).
            Get()
        if err == nil && len(logs) > 0 {
            log := logs[0]
            fmt.Printf("\n📋 转账记录: 用户%v -> 用户%v, 金额: %.2f, 状态: %s\n",
                log["from_user_id"], log["to_user_id"], log["amount"], log["status"])
        }
    }
    
    // 演示事务回滚
    fmt.Println("\n🔄 演示事务回滚...")
    err = transferMoney(1, 2, 10000.00)
    if err != nil {
        fmt.Printf("✅ 正确回滚: %v\n", err)
    }
}</code></pre>
                    </div>
                </div>
            </div>
        </section>

        <!-- 赞助商区域 -->
        <section class="sponsors">
            <div class="container">
                <h2 class="section-title">感谢我们的赞助商</h2>
                <div class="sponsor-tiers">
                    <div class="sponsor-tier">
                        <h3>白金赞助商</h3>
                        <div class="sponsor-cards">
                            <div class="sponsor-card placeholder">
                                <span>成为赞助商</span>
                            </div>
                        </div>
                    </div>
                    <div class="sponsor-tier">
                        <h3>黄金赞助商</h3>
                        <div class="sponsor-cards">
                            <div class="sponsor-card placeholder">
                                <span>成为赞助商</span>
                            </div>
                            <div class="sponsor-card placeholder">
                                <span>成为赞助商</span>
                            </div>
                            <div class="sponsor-card placeholder">
                                <span>成为赞助商</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>TORM</h4>
                    <p>Go语言的优雅ORM库</p>
                </div>
                <div class="footer-section">
                    <h4>文档</h4>
                    <a href="docs.html?doc=quick-start">快速开始</a>
                    <a href="docs.html?doc=configuration">配置指南</a>
                    <a href="#">API参考</a>
                </div>
                <div class="footer-section">
                    <h4>社区</h4>
                    <a href="https://github.com/zhoudm1743/torm" target="_blank">GitHub</a>
                    <a href="#">讨论区</a>
                    <a href="docs.html?doc=contributing">贡献指南</a>
                </div>
                <div class="footer-section">
                    <h4>其他</h4>
                    <a href="docs.html?doc=changelog">更新日志</a>
                    <a href="https://github.com/zhoudm1743/torm/issues" target="_blank">问题反馈</a>
                    <a href="docs.html?doc=troubleshooting">故障排除</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 TORM. <a href="https://beian.miit.gov.cn/" style="color: #fff;text-decoration: none;">浙ICP备19007147号-3</a></p>
            </div>
        </div>
    </footer>

    <script src="scripts/config.js"></script>
    <script src="scripts/main.js"></script>
</body>
</html> 